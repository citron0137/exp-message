---
title: 구조화된 로깅 전략 설계
tags: [개인 프로젝트, 로깅, 구조화 로깅, MDC, 분산 추적]
date: 2026-02-14
---

## 프로젝트 요약

- **한 줄 요약**: SLF4J 기반 평문 로깅에서 JSON 구조화 로깅으로 전환하여 디버깅·모니터링·분산 추적을 개선하기 위한 전략 수립
- **키워드**: `JSON 로깅`, `MDC`, `logstash-logback-encoder`, `분산 추적`, `로그 마스킹`, `Loki`

## 문제(AS-IS)

- SLF4J만 사용 중이며, 로그가 평문(plain text) 형식으로 출력됨
- 로그 레벨/구조화 전략이 없어 디버깅·모니터링 시 파싱·검색이 어려움
- 요청 단위 추적(traceId, spanId)이 없어 분산 환경에서 요청 흐름 추적 불가
- 민감 정보(비밀번호, 토큰 등) 로그 노출 위험에 대한 대응 전략 부재
- 로그 수집/중앙화 파이프라인(Loki 계획은 있으나) 미구현

## 목표(TO-BE)

1. JSON 형식의 구조화 로깅으로 로그 파싱·검색 용이성 확보
2. 환경별(dev/staging/prod) 로그 레벨·출력 형식 전략 수립
3. 로그 필드 표준화(timestamp, level, message, traceId, spanId 등)
4. MDC 기반 traceId/spanId로 분산 추적 가능하게 구성
5. 민감 정보 마스킹 규칙 수립
6. 로그 수집 스택 선택 및 연동 방향 결정

## 설계/선택(Key decisions)

(구현 후 채울 예정)

## 결과(Impact)

(구현 후 채울 예정)

---

## 구현 상세

### 1) JSON 형식의 구조화 로깅으로 로그 파싱·검색 용이성 확보

**배경**: 현재 Spring Boot 기본 Logback으로 평문 로그가 출력됨. 로그 수집(Loki 등)과 연동하려면 파싱 가능한 형식이 필요함. 목적은 로깅 인프라에서 파싱·검색·트레이스 연동을 쉽게 하는 것.

- **(후보1) stdout JSON (Logback 내장 JsonEncoder)**
  - (장점1) 추가 의존성 없음
  - (장점2) 구현 단순
  - (장점3) `kubectl logs`로 바로 확인 가능
  - (장점4) Promtail/Filebeat와 자연스럽게 연동
  - (단점1) 필드 on/off 위주, 커스터마이징 제한적
  - (단점2) trace_id는 MDC 별도 주입 필요
- **(후보2) stdout JSON (logstash-logback-encoder)**
  - (장점1) 후보 1의 장점 3, 4 포함
  - (장점2) 필드명·패턴·마스킹 등 커스터마이징 풍부
  - (장점3) ELK/Loki 연동 최적화
  - (단점1) 추가 의존성 필요
  - (단점2) trace_id는 MDC 별도 주입 필요
- **(후보3) OTel OTLP (OpenTelemetryAppender)**
  - (장점1) 앱에서 JSON 불필요
  - (장점2) trace_id 자동 부착
  - (장점3) 로그·트레이스·메트릭 통합
  - (단점1) Collector 필수, 설정 복잡
  - (단점2) 로그 처리 시 Collector 부하 큼(후보 1·2 대비)
    - Collector가 없는 경우(후보 1·2): 앱 → stdout → Promtail/Filebeat가 pull → Loki. Collector 경유 없음.
    - Collector가 있는 경우(후보 3): 앱 → OTLP push → Collector 수신·파싱·전달 → Loki. Collector가 로그 처리량 병목(항목당 비용 커서 동일 리소스에서 수~십 건/sec 수준).
  - (단점3) stdout에 로그 없어 디버깅 어려움

**결정**: stdout JSON (logstash-logback-encoder)
- 필드명·패턴·마스킹 등 커스터마이징 풍부
- 목표 5번(민감 정보 마스킹)에 적합
- Collector 경유 없어 로그 처리 성능 우수(후보 3 대비)
- trace_id는 목표 4번(MDC)에서 별도 처리

**적용 완료**: `build.gradle.kts` 의존성 추가, `logback-spring.xml` 생성(prod/staging=JSON, 그 외=평문)

