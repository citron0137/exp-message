# 메시지 실시간 통신 실제 도입

## 배경

실시간 통신을 실제로 도입하여 배포하고자함

## 목표

1. longpolling과 sse 제거
2. WebSocket을 보강할 수 있는 기능 추가
    1. Heartbeat 추가
    2. 서버 업데이트시 로직 (graceful shutdown 등) 한 번 더 확인
    3. 수평 확장 방식 고려 필요 (Message Queue, Stiky Session)
3. 프로토콜 문서화


## KeyDecision


## Impact

---

## 작업 내용 상세

### 2-1. Heartbeat 설정

**문제**: 네트워크 끊김 시 클라이언트가 즉시 감지하지 못하고, 죽은 연결이 서버에 남아 리소스 낭비

**해결**: 
- `WebSocketConfig.kt`: `setHeartbeatValue()` + `ThreadPoolTaskScheduler` 추가
- 효과: 10초마다 heartbeat 교환, 최대 30초 내 연결 끊김 감지

---

### 2-2. 서버 업데이트 안정성 설정 (Graceful Shutdown + 배포 전략)

**문제**: 
- 서버 종료 시 진행 중인 요청 중단 및 WebSocket 연결 갑자기 끊김
- 기본 배포 전략으로 인한 다운타임 발생 가능

**해결**:

**Graceful Shutdown**
- `application.properties`: `server.shutdown=graceful` + Actuator Probes 활성화
  - Liveness Probe: 애플리케이션 생존 여부 확인 (실패 시 Pod 재시작)
  - Readiness Probe: 트래픽 수신 준비 상태 확인 (실패 시 트래픽 차단)
- `values.yaml`: `terminationGracePeriodSeconds: 30`, Health Check 엔드포인트 변경
- `deployment.yaml`: `terminationGracePeriodSeconds` 변수화

**배포 전략**
- `values.yaml`: `strategy.type=RollingUpdate`, `maxSurge=1`, `maxUnavailable=0` 추가
- `deployment.yaml`: strategy 템플릿 추가

**효과**: 진행 중 요청 완료 대기(20초) → 새 Pod 준비 완료 후 기존 Pod 종료 → 무중단 배포 보장