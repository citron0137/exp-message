# 메시지 실시간 통신 실제 도입

## 배경

실시간 통신을 실제로 도입하여 배포하고자함

## 목표

1. longpolling과 sse 제거
2. WebSocket을 보강할 수 있는 기능 추가
    1. Heartbeat 추가
    2. 서버 업데이트시 로직 (graceful shutdown 등) 한 번 더 확인
    3. 수평 확장 방식 고려 필요 (Message Queue, Stiky Session)
3. 프로토콜 문서화


## KeyDecision

1. **Redis Pub/Sub 선택**: 이미 Redis 사용 중, 여러 Subscriber 지원 가능, Port-Adapter 패턴으로 향후 Kafka 교체 가능
2. **Spring ApplicationEvent 제거**: Redis Pub/Sub으로 충분, 불필요한 중간 레이어 제거
3. **MessageEvent DTO 분리**: 도메인 객체가 인프라 레이어로 유출 방지
4. **Sticky Session 필수**: WebSocket Stateful 특성상 같은 Pod 유지 필요


## Impact

1. **안정성**: Heartbeat + Graceful Shutdown + RollingUpdate로 무중단 배포 보장
2. **확장성**: 수평 확장 가능, Redis Pub/Sub으로 Pod 간 메시지 동기화, 여러 Subscriber 확장 가능
3. **아키텍처**: Port-Adapter 패턴으로 기술 교체 용이, 레이어 분리 명확
4. **포트폴리오**: 대규모 트래픽 대응 아키텍처 + Redis Pub/Sub 실전 활용 + K8s 배포 전략 경험

---

## 작업 내용 상세

### 2-1. Heartbeat 설정

**문제**: 네트워크 끊김 시 클라이언트가 즉시 감지하지 못하고, 죽은 연결이 서버에 남아 리소스 낭비

**해결**: 
- `WebSocketConfig.kt`: `setHeartbeatValue()` + `ThreadPoolTaskScheduler` 추가
- 효과: 10초마다 heartbeat 교환, 최대 30초 내 연결 끊김 감지

---

### 2-2. 서버 업데이트 안정성 설정 (Graceful Shutdown + 배포 전략)

**문제**: 
- 서버 종료 시 진행 중인 요청 중단 및 WebSocket 연결 갑자기 끊김
- 기본 배포 전략으로 인한 다운타임 발생 가능

**해결**:

**Graceful Shutdown**
- `application.properties`: `server.shutdown=graceful` + Actuator Probes 활성화
  - Liveness Probe: 애플리케이션 생존 여부 확인 (실패 시 Pod 재시작)
  - Readiness Probe: 트래픽 수신 준비 상태 확인 (실패 시 트래픽 차단)
- `values.yaml`: `terminationGracePeriodSeconds: 30`, Health Check 엔드포인트 변경
- `deployment.yaml`: `terminationGracePeriodSeconds` 변수화

**배포 전략**
- `values.yaml`: `strategy.type=RollingUpdate`, `maxSurge=1`, `maxUnavailable=0` 추가
- `deployment.yaml`: strategy 템플릿 추가

**효과**: 진행 중 요청 완료 대기(20초) → 새 Pod 준비 완료 후 기존 Pod 종료 → 무중단 배포 보장

---

### 2-3. 수평 확장 지원 (Redis Pub/Sub + Sticky Session)

**문제**: Pod 간 메시지 동기화 불가, WebSocket 연결 특정 Pod 고정 필요

**해결**: 
1. 테스트 환경 구축: `docker-compose.test.yml`로 앱 2개 + Nginx StickySession 설정
1. 어플리케이션 코드 개선: ApplicationEvnetPublisher 대신 RedisPubSub 도입
    - Redis Pub/Sub: Pod 간 메시지 브로드캐스트, 여러 Subscriber 확장 가능
    - Port-Adapter 패턴으로 인프라 의존을 낮춤
    - MessageEvent.Created가 도메인에 의존하지 않도록 만들어 도메인과 이벤트 프로토콜 분리
1. 테스트: 
    - Websocket을 기반으로 진행하는 기존 IT 코드 정상 작동
    - 03-sticky-session으로 테스트 성공

**고민**:
- 추후 Kafka 도입 필요 (redis broadcast의 한계)
- Coroutine 비동기 도입 고려 (Websocket은 io 집약적)
- sticky session 방법 개선 필요 (ip 기반은.. 더 나은 방안 없나? 유저기반 등..)

**효과**: 수평 확장 가능한 실시간 메시징 아키텍처, Port-Adapter로 기술 교체 용이