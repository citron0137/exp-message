# 패치노트 - 2026-01-09

## 인프라 개선 작업

### 1. Helm Umbrella 구조 통합 및 간소화

**변경 사항:**

- Helm의 umbrella 차트 구조를 `05-scripts/02-deploy-monolitic`에 통합
- 변경사항이 잦은 구조이므로 관리 편의성을 위해 단순화

**구조:**

- `05-scripts/02-deploy-monolitic/`: 통합된 Helm 차트 디렉토리
  - `Chart.yaml`: 서브차트 의존성 정의 (mysql, app-monolitic)
  - `values.yaml`: 통합 설정 파일
  - `templates/ingress.yaml`: Ingress 템플릿
  - `charts/`: 서브차트 패키지 디렉토리

**이점:**

- 배포 스크립트와 Helm 차트가 같은 위치에 있어 관리 용이
- 변경사항 반영이 빠르고 간단함
- 단일 디렉토리에서 모든 배포 관련 설정 관리

### 2. Swagger UI 추가

**구현 내용:**

- SpringDoc OpenAPI를 사용한 API 문서화 도구 추가
- Swagger UI를 통한 API 테스트 인터페이스 제공
- 환경 변수를 통한 동적 서버 URL 설정 지원

**의존성 추가 (`build.gradle.kts`):**

```kotlin
implementation("org.springdoc:springdoc-openapi-starter-webmvc-ui:2.6.0")
```

**설정 (`application.properties`):**

```properties
# SpringDoc OpenAPI Configuration
springdoc.api-docs.enabled=${API_DOCS_ENABLED:true}
springdoc.override-with-generic-response=false
springdoc.api-docs.path=/api-docs

springdoc.swagger-ui.enabled=${SWAGGER_UI_ENABLED:true}
```

**OpenAPI 설정 (`OpenApiConfig.kt`):**

- `SWAGGER_UI_HOST` 환경 변수를 통한 서버 URL 동적 설정
- 여러 호스트 지원 (쉼표로 구분)
- 환경 변수가 없으면 기본 동작 (자동 감지)

```kotlin
@Value("\${SWAGGER_UI_HOST:}")
private var swaggerHost: String = ""

// Host가 지정된 경우 Server 정보 추가 (쉼표로 구분된 여러 호스트 지원)
if (swaggerHost.isNotBlank()) {
    val hosts = swaggerHost.split(",").map { it.trim() }.filter { it.isNotBlank() }
    hosts.forEachIndexed { index, host ->
        openAPI.addServersItem(
            Server()
                .url(host)
                .description(if (hosts.size > 1) "API Server ${index + 1}" else "API Server")
        )
    }
}
```

**접근 경로:**

- API Docs: `/api-docs`
- Swagger UI: `/swagger-ui.html` 또는 `/swagger-ui/index.html`

**환경 변수:**

```bash
SWAGGER_UI_ENABLED=true
API_DOCS_ENABLED=true
SWAGGER_UI_HOST=https://message.rahoon.site/api  # 선택사항, 여러 호스트는 쉼표로 구분
```

### 3. X-Forwarded-Prefix를 사용한 Path Redirect 문제 해결

**문제 상황:**

- nginx-ingress 뒤에서 애플리케이션이 구동되면서 path redirect가 정확하지 않음
- Ingress에서 `/api` prefix를 제거하고 백엔드로 전달하지만, 백엔드에서 생성하는 redirect URL에 prefix가 누락됨

**해결 방법:**

- Ingress에서 `X-Forwarded-Prefix` 헤더를 설정하여 원본 path prefix 정보 전달
- 백엔드에서 `server.forward-headers-strategy=framework` 설정으로 헤더 정보 활용
- Spring Boot의 기본 `ForwardedHeaderFilter`가 자동으로 `X-Forwarded-*` 헤더 처리

**Ingress 설정 (`templates/ingress.yaml`):**

```yaml
annotations:
  nginx.ingress.kubernetes.io/rewrite-target: /$2
  nginx.ingress.kubernetes.io/x-forwarded-prefix: "/api"
```

**백엔드 설정 (`application.properties`):**

```properties
# Server Configuration
server.forward-headers-strategy=framework
```

**동작 방식:**

1. 클라이언트 요청: `https://message.rahoon.site/api/users`
2. Ingress에서 `/api` prefix 제거 후 백엔드로 전달: `/users`
3. Ingress가 `X-Forwarded-Prefix: /api` 헤더 추가
4. Spring Boot의 `forward-headers-strategy=framework`가 헤더를 읽어 redirect URL 생성 시 prefix 포함: `https://message.rahoon.site/api/users`

**참고:**

- Spring Boot의 `forward-headers-strategy=framework` 설정은 `X-Forwarded-*` 헤더를 자동으로 처리
- `X-Forwarded-Prefix` 헤더를 통해 원본 path prefix 정보를 유지할 수 있음
- 별도의 `ForwardedHeaderFilter` 빈 등록 없이도 기본 동작으로 처리됨
- Swagger UI와 같은 도구에서도 올바른 API 경로를 생성할 수 있음

### 4. Docker 빌드 최적화

**변경 사항:**

- Gradle 캐시 마운트를 사용하여 빌드 속도 향상
- 빌드 간 의존성 캐시 재사용으로 빌드 시간 단축

**Dockerfile 설정:**

```dockerfile
# Build the application without tests
RUN --mount=type=cache,target=/root/.gradle ./gradlew bootJar --no-daemon -x test
```

**이점:**

- Docker 빌드 캐시를 활용하여 반복 빌드 시 더 빠른 실행
- Gradle 의존성 캐시가 빌드 간에 유지되어 빌드 속도 향상

### 5. 테스트 컨트롤러 추가

**구현 내용:**

- E2E 테스트 및 헬스 체크를 위한 `TestController` 추가
- 서비스 상태 확인 및 에러 테스트 엔드포인트 제공

**엔드포인트:**

- `GET /test`: 서비스 상태 확인
- `GET /test/error`: 에러 테스트 (errorType 파라미터로 다양한 에러 타입 테스트 가능)

**사용 예시:**

```bash
# 서비스 상태 확인
curl http://message.rahoon.site/api/test

# 에러 테스트
curl http://message.rahoon.site/api/test/error?errorType=NOT_FOUND
```

### 배포 시 주의사항

**환경 변수 설정:**

- Swagger UI 활성화를 위한 환경 변수 확인
- 필요시 `SWAGGER_UI_HOST` 환경 변수로 서버 URL 명시적 설정

**Ingress 경로:**

- Swagger UI 접근: `https://message.rahoon.site/api/swagger-ui.html`
- API Docs 접근: `https://message.rahoon.site/api/api-docs`
- 테스트 엔드포인트: `https://message.rahoon.site/api/test`

**테스트:**

- Swagger UI에서 API 테스트 시 올바른 경로로 요청이 전달되는지 확인
- Redirect 응답 시 올바른 경로로 리다이렉트되는지 확인
- TestController를 통한 서비스 상태 확인
