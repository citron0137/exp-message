# 패치노트 - 2026-01-07

## 목표

Docker Compose를 사용하여 MySQL 데이터베이스를 로컬 개발 환경에 구성하고, Kubernetes를 사용하여 MySQL 데이터베이스를 클러스터 환경에 배포합니다. 또한 binlog를 설정하여 추후 특정 시점으로 데이터베이스를 복구할 수 있도록 구성합니다.

### 목표 설정 이유

1. 추후 DB를 서비스에 따라 분리하기 위함
2. 추후 DB를 클러스터로 관리하기 위함
3. 데이터 손실 시 특정 시점으로 복구할 수 있는 백업/복구 전략 수립

---

## 구현 내용

### 1단계: Docker Compose로 로컬 MySQL 환경 구성

#### 1.1 docker-compose.yml 작성
- MySQL 8.0 이미지 사용
- binlog 활성화 설정
- 데이터 영속성을 위한 볼륨 마운트
- 환경 변수 설정 (root 비밀번호, 데이터베이스명 등)
- 포트 매핑 (3306:3306)

#### 1.2 MySQL binlog 설정
- `my.cnf` 또는 환경 변수를 통한 binlog 활성화
- `log-bin` 설정
- `binlog_format=ROW` 설정 (ROW 기반 복제 및 복구)
- `expire_logs_days` 설정 (binlog 보관 기간)

#### 1.3 로컬 환경 테스트
- Docker Compose로 MySQL 컨테이너 실행
- binlog 활성화 확인
- 데이터베이스 연결 테스트

### 2단계: Kubernetes 매니페스트 작성

#### 2.1 ConfigMap 생성
- MySQL 설정 파일 (`my.cnf`) 포함
- binlog 설정 포함

#### 2.2 Secret 생성
- MySQL root 비밀번호
- 데이터베이스 사용자 정보

#### 2.3 PersistentVolumeClaim 생성
- MySQL 데이터 영속성을 위한 PVC
- StorageClass 설정

#### 2.4 Deployment 생성
- MySQL 컨테이너 정의
- ConfigMap, Secret, PVC 마운트
- 환경 변수 설정
- 리소스 제한 설정 (CPU, Memory)

#### 2.5 Service 생성
- ClusterIP 타입으로 MySQL 서비스 노출
- 포트 3306 매핑

### 3단계: Kubernetes 배포 및 검증

#### 3.1 Kubernetes 클러스터에 배포
- kubectl을 사용한 리소스 배포
- 배포 상태 확인

#### 3.2 MySQL 연결 테스트
- Pod 내부에서 MySQL 클라이언트로 연결 테스트
- 외부에서 포트 포워딩을 통한 연결 테스트

#### 3.3 binlog 동작 확인
- 데이터 변경 후 binlog 파일 생성 확인
- binlog 내용 조회 (`mysqlbinlog` 명령어)

### 4단계: 특정 시점 복구 테스트

#### 4.1 테스트 데이터 생성
- 샘플 데이터 삽입
- binlog 위치 기록

#### 4.2 데이터 삭제 시뮬레이션
- 테스트 데이터 삭제

#### 4.3 binlog를 이용한 복구
- binlog를 사용하여 특정 시점으로 복구
- 복구 결과 검증

---

## 진행 상황

### 현재 상태: MySQL 인스턴스에 PVC 연결 실패 중

#### 발생한 문제들

1. **StorageClass 문제**
   - Docker Desktop Kubernetes 환경에서 `standard` StorageClass가 존재하지 않음
   - `hostpath` StorageClass만 사용 가능
   - 해결: `hostpath` StorageClass 사용하도록 변경

2. **Windows 파일시스템 권한 문제**
   - Windows 파일시스템(NTFS)을 직접 마운트할 때 권한 문제 발생
   - MySQL 컨테이너가 `/var/lib/mysql` 디렉토리에 쓰기 권한 없음
   - 오류: `mysqld: File './mysql-bin.index' not found (OS errno 13 - Permission denied)`
   - 원인: Windows 파일시스템의 권한 모델이 Linux와 다름

3. **Data Dictionary 초기화 실패**
   - 오류: `Failed to find valid data directory`
   - 오류: `Data Dictionary initialization failed`
   - 원인: 볼륨 마운트는 되지만 MySQL이 데이터 디렉토리를 초기화하지 못함
   - Pod 상태: `CrashLoopBackOff`

4. **PVC 바인딩 문제**
   - hostPath를 사용할 때 PV와 PVC의 storageClassName 불일치
   - 해결: PV와 PVC 모두 `storageClassName: hostpath`로 통일

#### 시도한 해결 방법들

1. StorageClass를 `hostpath`로 변경
2. Windows 경로를 Docker Desktop WSL2 경로 형식으로 변환 (`/host_mnt/c/...`)
3. PV/PVC 템플릿에 `storageClassName` 명시적 지정
4. Pod에 직접 접속하여 디렉토리 권한 확인 (접속은 성공, MySQL 시작은 실패)

#### 현재 진행 중인 해결 시도

- MySQL 컨테이너를 root 권한(0/0)으로 실행하여 권한 문제 해결 시도
- 또는 initContainer를 사용하여 볼륨 권한 설정

---

## 주요 설계 결정사항

(구현 예정)

---

## 영향받는 코드

(구현 예정)
